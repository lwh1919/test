name: "[Test] Docker Publish"

on:
  push:
    branches:
      - main
  workflow_dispatch:

# concurrency:
#   group: ${{ github.workflow }}
#   cancel-in-progress: true

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    # å¦‚æœæœ‰è‡ªå»º runner ä½¿ç”¨ self-hostedï¼Œå¦åˆ™ç”¨ ubuntu-latest
    runs-on: ubuntu-latest
    # runs-on: self-hosted  # å¦‚æœæœåŠ¡å™¨é…ç½®äº† self-hosted runnerï¼Œå–æ¶ˆæ³¨é‡Šè¿™è¡Œå¹¶æ³¨é‡Šä¸Šé¢é‚£è¡Œ
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: api
            file: Dockerfile
            image: api

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.CONTAINER_REGISTRY_HOST }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
          logout: false
        continue-on-error: false
        timeout-minutes: 10

      - name: Build and push ${{ matrix.name }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.file }}
          push: true
          provenance: false
          tags: |
            ${{ secrets.CONTAINER_REGISTRY_HOST }}/workspace2/test1:latest
          # ä½¿ç”¨ GitHub Actions ç¼“å­˜ï¼ˆä»ç¼“å­˜è¯»å–å¹¶å†™å…¥ç¼“å­˜ï¼‰
          # mode=max: å­˜å‚¨æ‰€æœ‰å±‚çš„ç¼“å­˜ï¼ˆåŒ…æ‹¬æœªä½¿ç”¨çš„å±‚ï¼‰
          # mode=min: åªå­˜å‚¨æœ€ç»ˆé•œåƒçš„ç¼“å­˜ï¼ˆèŠ‚çœç©ºé—´ä½†ç¼“å­˜æ•ˆæœè¾ƒå·®ï¼‰
          cache-from: type=gha,scope=${{ matrix.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.name }}
        timeout-minutes: 30

   # å¯é€‰ï¼šä½¿ç”¨ Dokploy è‡ªåŠ¨éƒ¨ç½²
  dokploy-deploy-api:
     runs-on: ubuntu-latest
     needs: build-and-push
     steps:
       - name: Trigger Dokploy Deployment
         env:
           DOKPLOY_DOMAIN: ${{ secrets.DOKPLOY_DOMAIN }}
           DOKPLOY_AUTH_TOKEN: ${{ secrets.DOKPLOY_AUTH_TOKEN }}
           DOKPLOY_APPLICATION_ID: ${{ secrets.API_TEST_APP_ID }}
         run: |
           echo "ğŸš€ Starting Dokploy deployment..."
           echo "ğŸ“ Dokploy Domain: ${DOKPLOY_DOMAIN}"
           echo "ğŸ†” Application ID: ${DOKPLOY_APPLICATION_ID}"
           
           # è°ƒç”¨ Dokploy API éƒ¨ç½²
           HTTP_CODE=$(curl -s -o /tmp/dokploy_response.txt -w "%{http_code}" -X 'POST' \
             "http://${DOKPLOY_DOMAIN}/api/compose.deploy" \
             -H 'accept: application/json' \
             -H "x-api-key: ${DOKPLOY_AUTH_TOKEN}" \
             -H 'Content-Type: application/json' \
             -d "{\"composeId\":\"${DOKPLOY_APPLICATION_ID}\"}")
           
           echo "ğŸ“‹ Response Status Code: ${HTTP_CODE}"
           echo "ğŸ“„ Response Body:"
           cat /tmp/dokploy_response.txt
           echo ""
           
           # æ£€æŸ¥å“åº”çŠ¶æ€ç 
           if [ "${HTTP_CODE}" -ge 200 ] && [ "${HTTP_CODE}" -lt 300 ]; then
             echo "âœ… Dokploy deployment triggered successfully!"
             echo "ğŸ”— Check deployment status at: http://${DOKPLOY_DOMAIN}"
             exit 0
           elif [ "${HTTP_CODE}" -eq 401 ]; then
             echo "âŒ Authentication failed. Please check DOKPLOY_AUTH_TOKEN."
             exit 1
           elif [ "${HTTP_CODE}" -eq 404 ]; then
             echo "âŒ Application not found. Please check API_TEST_APP_ID."
             exit 1
           else
             echo "âŒ Dokploy deployment failed with HTTP status: ${HTTP_CODE}"
             echo "Please check Dokploy logs for more details."
             exit 1
           fi

